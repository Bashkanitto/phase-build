import{j as e,r as l,D as P,M as B,k as T,B as k,l as M,N as p,E as U,w as R,a as A,m as F,n as K,h as Z,b as q,S as $}from"./index-BwQ9_pH1.js";import{u as z,d as E,e as H,g as W,h as X,i as V,j as J,k as Q}from"./productService-Bt3BsnKr.js";import{E as L,N as G}from"./index-DTkkQkBg.js";import{u as Y,a as ee}from"./procentService-u-au2y4b.js";import"./clamp-DTmYCdls.js";const te="_container_896fr_34",se="_tabs_896fr_125",oe="_active_896fr_150",ae="_tabBody_896fr_155",ne="_downloadBtn_896fr_175",re="_documentAction_896fr_186",le="_productDocumentsItem_896fr_200",ie="_deleteProduct_896fr_204",ce="_deleteIcon_896fr_212",de="_group_896fr_223",f={"product-page":"_product-page_896fr_1","product-image":"_product-image_896fr_6","product-info":"_product-info_896fr_26",container:te,"product-breadcrumbs":"_product-breadcrumbs_896fr_45","product-count":"_product-count_896fr_58","product-price":"_product-price_896fr_62","product-order":"_product-order_896fr_93","product-details":"_product-details_896fr_96",tabs:se,active:oe,tabBody:ae,downloadBtn:ne,documentAction:re,productDocumentsItem:le,deleteProduct:ie,deleteIcon:ce,group:de},ue="_modalOverlay_1debc_1",pe="_modalContent_1debc_14",he="_fullImage_1debc_20",me="_closeButton_1debc_26",D={modalOverlay:ue,modalContent:pe,fullImage:he,closeButton:me},xe=({imageUrl:r,isOpen:t,onClose:i})=>t?e.jsx("div",{onClick:i,className:D.modalOverlay,children:e.jsx("div",{className:D.modalContent,children:e.jsx("img",{src:r.replace("http://3.76.32.115:3000","https://api.arbr.kz"),alt:"Full View",className:D.fullImage})})}):null,fe=({description:r})=>e.jsx("div",{style:{padding:"20px"},children:e.jsx(L.Markdown,{source:r,style:{whiteSpace:"pre-wrap"}})}),je=r=>e.jsx("svg",{width:"18",height:"19",viewBox:"0 0 18 19",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r,children:e.jsx("path",{d:"M9 14V4M9 14L6 11M9 14L12 11M3 18H15",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})}),ge=({product:r})=>{const[t,i]=l.useState(!1),[o,j]=l.useState(null),[g,b]=l.useState([]),S=async n=>{try{await M.delete(`/upload/${n}`),p.addNotification("Документы","Документы успешно уделен!","success")}catch(h){console.error(h),p.addNotification("Документы","Произошла ошибка при удалении документа!","error")}},_=async(n,h)=>{try{const C=await(await fetch(n)).data.blob(),y=document.createElement("a"),d=URL.createObjectURL(C);y.href=d,y.download=`${h.split(".")[0]}.xlsx`,y.click(),URL.revokeObjectURL(d)}catch(u){console.error("Error while downloading file:",u)}},m=async()=>{var h;if(g.length<=0){j("Выберите файл");return}j(null);const n=["xlsx","pdf"];for(const u of g){const C=(h=u.name.split(".").pop())==null?void 0:h.toLowerCase();if(!C||!n.includes(C)){p.addNotification("Документы","Неверный формат файла. Допустимы только файлы с расширением .xlsx или .pdf.","error");return}}try{await z(g,r.vendorGroups[0].id),p.addNotification("Документы","Документы успешно добавлены!","success"),i(!1)}catch(u){console.error(u),p.addNotification("Документы","Произошла ошибка при добавлении документа!","error"),i(!1)}};return e.jsxs("div",{className:f.tabBody,children:[e.jsx("ul",{className:"flex",children:r.vendorGroups[0].productDocuments.map(n=>e.jsxs("li",{className:f.productDocumentsItem,children:[n.originalname,e.jsxs("div",{className:f.documentAction,children:[e.jsx("a",{onClick:()=>_(n.url,n.originalname),children:e.jsx(je,{})}),e.jsx("a",{onClick:()=>S(n.filename),children:e.jsx(P,{})})]})]},n.id))}),e.jsxs(B,{withCloseButton:!1,opened:t,onClose:()=>i(!1),children:[e.jsx(T,{type:"file",onChange:n=>n.target.files&&b(Array.from(n.target.files))}),e.jsx("p",{style:{color:"grey",margin:"10px 0"},children:"Допустимые форматы: xlsx, pdf"}),o&&e.jsx("p",{style:{color:"red"},children:o}),e.jsx(k,{style:{width:"100%"},variantColor:"primary",onClick:m,children:"Отправить"})]}),e.jsx(k,{variantColor:"primary",onClick:()=>i(!0),children:"Добавить документ"})]})},ye=({productId:r})=>{const[t,i]=l.useState(!1),[o,j]=l.useState(),[g,b]=l.useState([]),[S,_]=l.useState(""),[m,n]=l.useState([]),[h,u]=l.useState({title:"",items:[{value:"",productId:r}]});l.useEffect(()=>{(async()=>{try{const c=await E();b(c.data.records)}catch(c){console.log(c)}})()},[]);async function C(){if(!h.title.trim()||m.some(s=>!s.value.trim()||!s.productId)){_("Заполните все поля");return}try{const s=await H(String(o==null?void 0:o.id),{title:h.title,items:m});p.addNotification("Группа","Группа успешно обновлена:","success"),i(!1)}catch(s){console.error(s),_("Ошибка при сохранении"),p.addNotification("Группа","Произошла ошибка:","error")}finally{n([{value:"",productId:""}]),_("")}}const y=(s,c,w)=>{const a=[...m];a[s][c]=w,console.log(a[s][c]),n(a)},d=async s=>{try{await W(s),p.addNotification("Группы","Группа удачно удалена","success");const c=await E();b(c.data.records)}catch(c){console.log(c),p.addNotification("Группы","Произошла ошибка при удалении группы","error")}};async function x(){try{await M.post("/group",{title:"Название",items:[{value:"Значение",productId:r}]}),p.addNotification("Группы","Группа удачно создана","success");const s=await E();b(s.data.records)}catch(s){console.log(s),p.addNotification("Группы","Произошла ошибка при создании группы","error")}}function N(s){s!==void 0&&n(c=>c.filter(w=>w.id!==s))}return e.jsxs("div",{style:{marginTop:"10px",display:"flex",flexDirection:"column",gap:"10px"},children:[g.map(s=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",marginTop:"10px"},children:[e.jsxs("div",{children:[s.title,":"]}),e.jsxs("div",{style:{justifySelf:"flex-end"},children:[e.jsx(P,{onClick:()=>d(s.id)}),e.jsx(U,{onClick:()=>{i(!0),j(s),n(s.groupItems),u({title:s.title,items:s.groupItems})}})]}),e.jsx("div",{style:{display:"flex",gap:"10px"},children:s.groupItems.map(c=>e.jsx("button",{className:f.group,onClick:()=>console.log(s),children:c.value},c.id))})]},s.id)),e.jsx(k,{onClick:x,children:"Add"}),e.jsxs(B,{opened:t,onClose:()=>i(!1),children:[e.jsx(T,{title:"Название",placeholder:"Название",value:h.title,style:{marginBottom:"10px"},onChange:s=>u({...h,title:s.target.value})}),m.map((s,c)=>e.jsxs("div",{style:{display:"flex",marginBottom:"10px"},children:[e.jsx(T,{value:s.value,onChange:w=>y(c,"value",w.target.value),placeholder:"Значение"}),e.jsx(T,{defaultValue:r,value:s.productId,onChange:w=>y(c,"productId",w.target.value),placeholder:"ID продукта"}),e.jsx(P,{onClick:()=>N(s.id)})]},c)),e.jsx("button",{style:{color:"gray",width:"100%"},onClick:()=>n([...m,{value:"",productId:""}]),children:"Добавить Группу"}),S&&e.jsx("p",{style:{color:"red"},children:S}),e.jsx(k,{style:{width:"100%"},variantColor:"primary",onClick:C,children:"Сохранить"})]})]})},ve=({product:r})=>{const[t,i]=l.useState("описание");return e.jsxs("div",{className:f.tabs,children:[e.jsx("ul",{children:["описание","Документы","Группы"].map(o=>e.jsx("li",{className:t===o?f.active:"",onClick:()=>i(o),children:o},o))}),t==="описание"&&e.jsx(fe,{description:r.description}),t==="Документы"&&e.jsx(ge,{product:r}),t==="Группы"&&e.jsx(ye,{productId:r.id})]})},we=({product:r,id:t,setProduct:i})=>{var y;const[o,j]=l.useState([]),[g,b]=l.useState(!1),[S,_]=l.useState(""),[m,n]=l.useState({image:!1,document:!1});function h(d){_(d),b(!0)}const u=async()=>{var x;if(o.length===0){p.addNotification("Ошибка","Выберите изображение","error");return}const d=["jpg","jpeg","png"];for(const N of o){const s=(x=N.name.split(".").pop())==null?void 0:x.toLowerCase();if(!s||!d.includes(s)){p.addNotification("Ошибка","Допустимые форматы: jpg, png","error");return}}try{await X(o,r.id)?p.addNotification("Успех","Изображение загружено!","success"):p.addNotification("Ошибка","файл слишком большой или проблемы с сервером","error");const s=await V(t);i(s==null?void 0:s.data),n({...m,image:!1})}catch(N){console.log(N)}finally{j([])}},C=async d=>{try{await M.delete(`/upload/${d}`),p.addNotification("Изображение","Изображение успешно удалено!","success"),R(1e3).then(()=>window.location.reload())}catch{p.addNotification("Изображение","Произошла ошибка при удалении изображения!","error")}};return e.jsxs("div",{className:f["product-image"],children:[(y=r.images)==null?void 0:y.map(d=>e.jsxs("div",{style:{position:"relative"},children:[e.jsx("img",{onClick:()=>h(d.url),style:{cursor:"pointer"},src:d.url.replace("http://3.76.32.115:3000","https://api.arbr.kz")}),e.jsx("div",{className:f.deleteIcon,onClick:()=>C(d.filename),children:"X"})]},d.id)),r.youtubeVideoUrl&&e.jsx("iframe",{width:"600",height:"400",src:r.youtubeVideoUrl,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0}),e.jsx(k,{onClick:()=>n({...m,image:!0}),children:"Добавить фото"}),e.jsx(ve,{product:r}),e.jsxs(B,{withCloseButton:!1,opened:m.image,onClose:()=>n({...m,image:!1}),children:[e.jsx(T,{type:"file",onChange:d=>j(d.target.files?Array.from(d.target.files):[]),multiple:!0}),e.jsx("p",{style:{color:"grey",margin:"10px 0"},children:"Допустимые форматы: jpg, png"}),e.jsx(k,{variantColor:"primary",onClick:u,children:"Загрузить"})]}),e.jsx(xe,{imageUrl:S,isOpen:g,onClose:()=>b(!1)})]})},be=({isOpen:r,setIsEditModalOpen:t,product:i,formData:o,setFormData:j})=>{var N,s,c,w;const[g,b]=l.useState([]),[S,_]=l.useState((N=i==null?void 0:i.vendorGroups[0].features)==null?void 0:N.bonus),[m,n]=l.useState((s=i.vendorGroups[0].feature)==null?void 0:s.discount),[h,u]=l.useState(""),[C,y]=l.useState([]),d=async()=>{var a,I;try{const v=await J(i==null?void 0:i.id,o);if(await Y((a=i.vendorGroups[0])==null?void 0:a.id,S),await ee((I=i.vendorGroups[0])==null?void 0:I.id,m),p.addNotification("Товар","Товар успешно отредактирован!","success"),t(!1),v.status!==200)throw new Error("Произошла ошибка при редактировании товара!")}catch(v){p.addNotification("Товар","Произошла ошибка при редактировании товара!","error"),console.error("Ошибка при редактировании товара:",v)}},x=async(a,I)=>{j(v=>({...v,[a]:I}))};return l.useEffect(()=>{(async()=>{const v=(await F()).data.records.map(O=>({value:O.id.toString(),label:O.name}));b(v),y(v)})()},[]),l.useEffect(()=>{const a=h.trim()===""?g:g.filter(I=>I.label.toLowerCase().includes(h.toLowerCase()));y(a)},[h,g]),e.jsxs(B,{opened:r,withCloseButton:!1,onClose:()=>t(!1),children:[e.jsx(T,{required:!0,label:"Название товара",value:o.name,onChange:a=>x("name",a.currentTarget.value)}),e.jsx("label",{htmlFor:"mdEditor",children:"Описание"}),e.jsx(L,{id:"mdEditor",value:o.description,onChange:a=>x("description",a),height:400}),e.jsx(G,{label:"Количество",value:o.quantity,onChange:a=>x("quantity",a??0)}),e.jsx(G,{label:"Цена",value:o.price,onChange:a=>x("price",a??0)}),e.jsx(A,{label:"Бренд",data:C,searchable:!0,searchValue:h,onSearchChange:u,defaultValue:o.brand,placeholder:"Выберите бренд..."}),e.jsx(G,{label:"Бонус %",max:100,value:(c=o.vendorGroups[0].features)==null?void 0:c.bonus,min:0,placeholder:"Введите бонус (0 - 100)",onChange:a=>_(a)}),e.jsx(G,{label:"Скидка %",max:100,value:(w=o.vendorGroups[0].features)==null?void 0:w.discount,min:0,placeholder:"Введите бонус (0 - 100)",onChange:a=>n(a)}),e.jsx(G,{label:"ЕНС ТРУ",placeholder:"Введите ЕНС ТРУ",value:o.ENSTRU,onChange:a=>x("ENSTRU",a??0)}),e.jsx(G,{label:"GTIN",value:o.GTIN,placeholder:"Введите GTIN",onChange:a=>x("GTIN",a??0)}),e.jsx(G,{label:"KZTIN",placeholder:"Введите KZTIN",value:o.KZTIN,onChange:a=>x("KZTIN",a??0)}),e.jsx(k,{variantColor:"primary",onClick:d,children:"Сохранить"})]})},ke=()=>{var d,x,N,s,c,w,a;const{id:r}=K(),[t,i]=l.useState(),[o,j]=l.useState(),[g,b]=l.useState(null),[S,_]=l.useState(!1),[m,n]=l.useState(),h=Z(),u=q.userProfile,C=(u==null?void 0:u.role)==="admin"||(u==null?void 0:u.role)==="vendor"&&((d=t==null?void 0:t.vendorGroups)==null?void 0:d.some(I=>I.vendor.id===u.id));l.useEffect(()=>{(async()=>{try{const v=await V(r);n(v.data),i(v.data)}catch(v){b(v.message||"An unknown error occurred")}})()},[r]);const y=async I=>{try{await Q(I),p.addNotification("Продукт","Продукт успешно удален!","success")}catch{p.addNotification("Продукт","Произошла ошибка при удалении продукта!","error")}};return g?e.jsx("div",{children:g}):t?e.jsxs("div",{className:f["product-page"],children:[e.jsx(we,{product:t,id:r,setProduct:i}),e.jsxs("div",{className:f["product-info"],children:[e.jsxs("div",{className:f.container,children:[e.jsxs("p",{className:f["product-breadcrumbs"],children:[e.jsx("span",{children:(x=t.subcategory)==null?void 0:x.name})," ",e.jsx("span",{children:(N=t.brand)==null?void 0:N.name})]}),e.jsx("h4",{children:t.name}),e.jsxs("p",{className:f["product-count"],children:[e.jsx("span",{style:{color:t.quantity<20?"red":"green"},children:t.quantity})," ","в наличии"]}),e.jsxs("div",{className:f["product-price"],children:[e.jsxs("div",{children:[(s=t==null?void 0:t.vendorGroups[0].features)!=null&&s.isDiscount?e.jsx("span",{children:e.jsxs("s",{children:[t.price,"₸ "]})}):e.jsx("span",{children:"Цена за товар"}),((c=t==null?void 0:t.vendorGroups[0].features)==null?void 0:c.isBonus)&&e.jsxs("span",{style:{background:"green",marginLeft:"10px"},children:[t.price*Number(t.vendorGroups[0].features.bonus)/100,"Б"]})]}),e.jsxs("p",{children:[(w=t==null?void 0:t.vendorGroups[0].features)!=null&&w.discount?t.price*(1-((a=t==null?void 0:t.vendorGroups[0].features)==null?void 0:a.discount)/100):new Intl.NumberFormat("en-KZ").format(t.price),"₸"]})]}),C&&e.jsx("button",{onClick:()=>_(!0),children:"ИЗМЕНИТЬ ПРОДУКТ"}),e.jsxs("div",{className:f["product-details"],children:[e.jsxs("a",{onClick:()=>j(1),children:["ЕНС ТРУ",e.jsx("p",{style:{height:o==1?"40px":"0px"},children:t.ENSTRU})]}),e.jsxs("a",{onClick:()=>j(2),children:["GTIN (штрихкод)",e.jsx("p",{style:{height:o==2?"40px":"0px"},children:t.GTIN})]}),e.jsxs("a",{onClick:()=>j(3),children:["KZTIN (для гос. закупок)",e.jsx("p",{style:{height:o==3?"40px":"0px"},children:t.KZTIN})]}),e.jsxs("a",{onClick:()=>j(4),children:["Адресс",e.jsx("p",{style:{height:o==4?"40px":"0px"},children:t.location})]})]})]}),t.status!=="active"?e.jsx(k,{onClick:()=>{y(t.id),R(1e3).then(()=>h(-1))},style:{width:"95%",margin:"10px"},children:"Удалить продукт"}):e.jsx("p",{style:{padding:"20px 40px",margin:"0 auto",color:"grey"},children:"Продукт активно используется"})]}),e.jsx(be,{isOpen:S,setIsEditModalOpen:_,product:t,formData:m,setFormData:n})]}):e.jsx($,{})};export{ke as default};
